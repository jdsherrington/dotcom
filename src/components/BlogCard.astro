---
import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";
import { extractOKLCHColors } from "../lib/extractOKLCHColors";

import CardTag from "@/components/CardTag.astro";
import NavigationButton from "@/components/NavigationButton.astro";

interface Props {
	id: string;
	title: string;
	description: string;
	date: string;
	url: string;
	tags: string[];
	imagePath: string;
	imageAlt: string;
	wordCount?: number;
	type: string;
}

const {
	id,
	title,
	description,
	date,
	url,
	tags,
	imagePath,
	imageAlt,
	type,
	wordCount,
} = Astro.props;

const formattedDate = new Date(date).toLocaleDateString("en-AU", {
	year: "numeric",
	month: "long",
	day: "2-digit",
});

const accentPalette: any = await extractOKLCHColors(imagePath);
const accent = accentPalette[0];
console.log(accent);

let readTime = 0;
if (wordCount) {
	readTime = Math.round(wordCount / 250);
}

const images = import.meta.glob<{ default: ImageMetadata }>(
	"/src/assets/blog/posts/*.{jpeg,jpg,png,gif,webp}",
);

if (!images[imagePath])
	throw new Error(
		`"${imagePath}" does not exist in glob: "src/assets/blog/posts/*"`,
	);
---

<div
	id=`blog-post-${id}`
	transition:persist
	class="blog-post card flex sm:flex-row md:flex-col [&[data-type='featured']]:flex-row [&[data-type='featured']]:md:col-span-2 [&[data-type='featured']]:lg:col-span-3"
	style="--accent-foreground: from oklch(var(--accent)) var(--shade-foreground) c
			h;
		--accent-background: from oklch(var(--accent)) var(--shade-background) c
			h;"
	data-accent={accent}
	data-type={type}
>
	<a
		id=`blog-post-img-${id}`
		href={url}
		transition:persist
		class="blog-post-img z-10 cursor-pointer"
		data-loaded="false"
	>
		<Image
			src={images[imagePath]()}
			alt={imageAlt}
			onload="this.parentElement.dataset.loaded = 'true'"
			class="in-[&[data-type='featured']]:sm:w-col-half in-[&[data-type='featured']]:md:max-h-col-4 in-[&[data-type='featured']]:lg:max-h-col-5 in-[&[data-type='standard']]:sm:w-col-1 in-[&[data-type='standard']]:md:h-col-2 h-full w-full object-cover in-[&[data-type='featured']]:sm:min-h-full in-[&[data-type='standard']]:md:w-full"
		/>
	</a>
	<div id=`blog-post-accent-${id}` transition:persist class="card-accent z-0">
	</div>
	<div
		id=`blog-post-content-${id}`
		class="p-gutter in-[&[data-type='featured']]:justify-center"
	>
		<small
			id=`blog-post-featured-${id}`
			class="blog-post-featured [.blog-post[data-type='featured']_&]:text-foreground/50 hidden [.blog-post[data-type='featured']_&]:block [.blog-post[data-type='featured']_&]:h-min [.blog-post[data-type='featured']_&]:max-w-full [.blog-post[data-type='featured']_&]:place-content-start [.blog-post[data-type='featured']_&]:pb-2 [.blog-post[data-type='featured']_&]:font-mono [.blog-post[data-type='featured']_&]:text-xs [.blog-post[data-type='featured']_&]:tracking-widest"
			>FEATURED POST</small
		>

		<a href={url}>
			<h1
				id=`blog-post-title-${id}`
				transition:persist
				class="blog-post-title text-foreground/85 hover:text-foreground inline h-min w-fit !leading-[1.2] font-bold tracking-tight text-pretty transition-colors duration-300 ease-in-out sm:text-xl [.blog-post[data-type='featured']_&]:font-bold [.blog-post[data-type='featured']_&]:sm:mt-2 [.blog-post[data-type='featured']_&]:sm:text-2xl [.blog-post[data-type='featured']_&]:md:text-2xl [.blog-post[data-type='featured']_&]:lg:text-3xl"
			>
				{title}
			</h1>
		</a>

		<small
			id=`blog-post-date-${id}`
			transition:persist
			class="blog-post-date text-foreground/50 mt-0.5 mb-1 h-min w-auto transform-none place-content-start py-1 pr-4 font-mono text-xs tracking-widest uppercase transition-colors duration-300 ease-in-out"
		>
			// {formattedDate}
		</small>

		<p
			id=`blog-post-description-${id}`
			transition:name=`description-${url}`
			class="blog-post-description text-foreground/70 sm:mb-gutter md:pr-gutter md:mb-gutter-1/2 sm:pr-gutter-2 [.blog-post[data-type='featured']_&]:pr-gutter h-min w-auto place-content-start text-sm text-pretty sm:hidden md:line-clamp-3 [.blog-post[data-type='featured']_&]:line-clamp-3"
		>
			{description}
		</p>

		<div
			id=`blog-post-tags-${id}`
			transition:persist
			class="blog-post-tags pb-gutter-1/2 [.blog-post[data-type='featured']_&]:sm:mb-gutter place-content-start justify-start [.blog-post[data-type='featured']_&]:grow-0 [.blog-post[data-type='featured']_&]:sm:flex [.blog-post[data-type='featured']_&]:sm:pb-0 [.blog-post[data-type='featured']_&]:md:mb-0"
		>
			{tags?.map((tag: any) => <CardTag text={tag} collection="blog" />)}
		</div>
		<div
			id=`blog-post-button-${id}`
			class="blog-post-button pb-gutter-1/2 [.blog-post[data-type='featured']_&]:right-gutter [.blog-post[data-type='featured']_&]:bottom-gutter-1/2 inline-flex h-auto w-full justify-end justify-self-end [.blog-post[data-type='featured']_&]:absolute [.blog-post[data-type='featured']_&]:w-auto [.blog-post[data-type='featured']_&]:pb-0"
		>
			<NavigationButton
				link={url}
				text=`// ${readTime} min read`
				direction="forward"
				position="bottom-right"
				className="bg-foreground/0 text-foreground/60 py-gutter-1/2 group-hover:text-foreground/80 group-hover:hover:text-accent-foreground static px-0 backdrop-blur-none transition-all duration-200 ease-in-out group-hover:hover:bg-transparent sm:hidden md:flex"
			/>
		</div>
	</div>
</div>

<script>
	const setPostAccents = () => {
		// Set post accents
		document.querySelectorAll<HTMLElement>(".blog-post").forEach((post) => {
			const currentTheme =
				document.documentElement.getAttribute("data-theme");

			if (currentTheme === "dark" || currentTheme === "light") {
				post.style.setProperty("--accent", `${post.dataset.accent}`);
			}
		});

		// Style featured post accent
		const featuredCard = document.querySelector<HTMLElement>(
			".card[data-type='featured']",
		);
		if (featuredCard) {
			featuredCard.classList.add("featured");
		}

		const featuredAccent = document.querySelector<HTMLElement>(
			".blog-post[data-type='featured'] .card-accent",
		);
		if (featuredAccent) {
			featuredAccent.classList.add("featured");
		}
	};

	// Attach initial event listeners
	setPostAccents();
	document.addEventListener("astro:after-swap", () => {
		setPostAccents();
	});
</script>
